<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>3D Viewer</title>

<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://static.wixstatic.com" crossorigin>

<style>
  html,body{margin:0;background:transparent}
  .wrap{max-width:980px;margin:0 auto;padding:0}
  model-viewer{
    width:100%;
    height:550px;                   /* גובה קבוע = פחות קפיצות */
    background:transparent;
    border-radius:0;
    --progress-bar-color: transparent;
    --progress-bar-height: 0px;
  }
  @media (max-width:600px){
    model-viewer{height:430px}      /* מפחית עומס ב-iPhone */
  }
  .fallback{display:none;margin:12px auto 0;text-align:center;font:500 15px/1.4 system-ui}
  .fallback a{color:#0aa; text-decoration:underline}
</style>
</head>
<body>
  <div class="wrap">
    <model-viewer id="mv"
      src="https://cdn.jsdelivr.net/gh/sigallshaull-del/CAELI-3D@main/Crusoe_HP_08.glb"
      poster="https://static.wixstatic.com/media/46e83d_9773fd7a0e9b4646aa02baf3bc7bed8b~mv2.png"
      reveal="auto"
      alt="CRUSOE HP 3D"
      camera-controls
      shadow-intensity="0"
      exposure="1.0"
      crossorigin="anonymous">
    </model-viewer>

    <p id="fb" class="fallback">
      Having trouble loading? <a id="open" href="#" target="_blank" rel="noopener">Open in a new tab</a>
    </p>
  </div>

  <script>
    const mv = document.getElementById('mv');
    const fb = document.getElementById('fb');
    const open = document.getElementById('open');

    // קישורי גיבוי
    const primarySrc = "https://cdn.jsdelivr.net/gh/sigallshaull-del/CAELI-3D@main/Crusoe_HP_08.glb";
    const secondarySrc = "https://sigallshaull-del.github.io/CAELI-3D/Crusoe_HP_08.glb";
    open.href = secondarySrc;

    // זיהוי iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // מפעילים סיבוב רק בדסקטופ לבריאות GPU במובייל
    mv.addEventListener('load', () => {
      if (!isIOS) mv.autoRotate = true;
    });

    // אם הפוסטר לא נעלם באייפון, נכפה הסרה עדינה
    const forceDismiss = () => { try { mv.dismissPoster(); } catch(_) {} };
    setTimeout(forceDismiss, 1200);
    mv.addEventListener('click', forceDismiss, { once:true });
    mv.addEventListener('touchstart', forceDismiss, { passive:true, once:true });
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) setTimeout(forceDismiss, 200);
    }, { once:true });

    // אם יש שגיאת טעינה, ננסה מקור חלופי ואז נראה fallback
    mv.addEventListener('error', () => {
      if (mv.src !== secondarySrc) {
        mv.src = secondarySrc;
        open.href = secondarySrc;
        setTimeout(forceDismiss, 800);
      } else {
        fb.style.display = 'block';
      }
    });

    // אם Safari מאבד הקשר WebGL (מחסור זיכרון) — מונעים לולאת רענון ומראים קישור
    mv.addEventListener('webglcontextlost', (e) => {
      e.preventDefault();
      fb.style.display = 'block';
    }, { once:true });
  </script>
</body>
</html>
